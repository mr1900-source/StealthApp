{% extends "base.html" %}
{% set active_page = "home" %}

{% block content %}
    <!-- Hero Section -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold mb-3">
            <i class="bi bi-map text-primary"></i> Plan Your Perfect Trip
        </h1>
        <p class="lead text-muted">AI-powered itineraries in seconds. Customize, save, and share your adventures.</p>
    </div>

    <!-- Generation Form -->
    <div class="form-section">
        <h3><i class="bi bi-pencil-square me-2"></i>Tell Us About Your Trip</h3>
        <form id="generateForm" action="{{ url_for('main.plan') }}" method="post">
            
            <!-- Basic Info Grid -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="destination"><i class="bi bi-geo-alt-fill me-1"></i> Destination *</label>
                    <input 
                        type="text" 
                        id="destination" 
                        name="destination" 
                        class="form-control" 
                        placeholder="e.g., Paris, Tokyo, NYC"
                        value="{% if form_data %}{{ form_data.destination }}{% endif %}"
                        required>
                </div>

                <div class="form-group">
                    <label for="duration"><i class="bi bi-calendar-range me-1"></i> Duration *</label>
                    <select id="duration" name="duration" class="form-select" required>
                        <option value="">Select duration...</option>
                        <option value="half-day">Half Day (4-6 hours)</option>
                        <option value="full-day">Full Day (8-12 hours)</option>
                        <option value="weekend">Weekend (2-3 days)</option>
                        <option value="3-5 days">3-5 Days</option>
                        <option value="week">One Week</option>
                        <option value="2-weeks">Two Weeks</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="travelers"><i class="bi bi-people-fill me-1"></i> Number of Travelers</label>
                    <input 
                        type="number" 
                        id="travelers" 
                        name="travelers" 
                        class="form-control" 
                        placeholder="e.g., 2"
                        min="1"
                        max="20"
                        value="{% if form_data %}{{ form_data.travelers }}{% endif %}">
                </div>

                <div class="form-group">
                    <label for="budget"><i class="bi bi-cash-coin me-1"></i> Budget (Total USD)</label>
                    <input 
                        type="number" 
                        id="budget" 
                        name="budget" 
                        class="form-control" 
                        placeholder="e.g., 1000"
                        min="0"
                        step="50"
                        value="{% if form_data %}{{ form_data.budget }}{% endif %}">
                </div>
            </div>

            <!-- Time Preferences -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="start_time"><i class="bi bi-clock me-1"></i> Preferred Start Time</label>
                    <select id="start_time" name="start_time" class="form-select">
                        <option value="">Any time</option>
                        <option value="early-morning">Early Morning (6-8 AM)</option>
                        <option value="morning">Morning (8-10 AM)</option>
                        <option value="late-morning">Late Morning (10 AM-12 PM)</option>
                        <option value="afternoon">Afternoon (12-3 PM)</option>
                        <option value="evening">Evening (6-9 PM)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="pace"><i class="bi bi-speedometer2 me-1"></i> Travel Pace</label>
                    <select id="pace" name="pace" class="form-select">
                        <option value="">Standard</option>
                        <option value="relaxed">Relaxed - Fewer stops, more time</option>
                        <option value="moderate">Moderate - Balanced schedule</option>
                        <option value="fast">Fast-paced - Pack in the activities</option>
                    </select>
                </div>
            </div>

            <!-- Interests -->
            <div class="form-group mb-4">
                <label for="interests"><i class="bi bi-star-fill me-1"></i> Interests & Preferences</label>
                <textarea 
                    id="interests" 
                    name="interests" 
                    class="form-control" 
                    rows="4"
                    maxlength="500"
                    placeholder="Tell us what you love! Examples: museums, food tours, hiking, nightlife, photography, local markets, hidden gems, family-friendly, romantic, adventure sports...">{% if form_data %}{{ form_data.interests }}{% endif %}</textarea>
                <small class="text-muted">Be specific! The more details, the better your itinerary.</small>
            </div>

            <!-- Special Requirements -->
            <div class="form-group mb-4">
                <label for="special_requirements"><i class="bi bi-info-circle me-1"></i> Special Requirements (Optional)</label>
                <input 
                    type="text" 
                    id="special_requirements" 
                    name="special_requirements" 
                    class="form-control" 
                    placeholder="e.g., wheelchair accessible, vegetarian restaurants, pet-friendly"
                    value="{% if form_data %}{{ form_data.special_requirements }}{% endif %}">
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="bi bi-magic me-2"></i> Generate My Itinerary
                </button>
            </div>
        </form>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <p class="text-muted">Creating your perfect itinerary...</p>
    </div>

    <!-- Generated Itinerary Display -->
    {% if itinerary %}
    <div id="itineraryResult" class="itinerary-container">
        <div class="text-center mb-4">
            <h2 class="display-6 fw-bold"><i class="bi bi-calendar-check me-2"></i>Your Personalized Itinerary</h2>
            <p class="text-muted">Review, edit, and save your trip plan below</p>
        </div>

        {% set sections = itinerary.split('STOP:') %}
        {% for item in sections if item.strip() %}
            {% if 'EXTRA TIPS' in item.upper() %}
                <!-- Extra Tips Section -->
                <div class="extra-tips">
                    <h4><i class="bi bi-lightbulb-fill me-2"></i>Travel Tips</h4>
                    <ul>
                        {% set tips = item.replace('EXTRA TIPS', '').replace('Extra Tips', '').strip().split('\n') %}
                        {% for tip in tips if tip.strip() %}
                            <li>{{ tip.strip() }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <!-- Regular Stop -->
                {% set lines = item.strip().split('\n') %}
                {% set first_line = lines[0] if lines else '' %}
                {% set time_and_title = first_line.split(' - ', 1) %}
                {% set time = time_and_title[0].strip() if time_and_title|length > 0 else '' %}
                {% set title = time_and_title[1].strip() if time_and_title|length > 1 else first_line %}
                
                <div class="itinerary-stop">
                    <div class="stop-header">
                        <div class="stop-time">
                            <i class="bi bi-clock-fill"></i>
                            <span>{{ time }}</span>
                        </div>
                        <div class="stop-controls">
                            <button type="button" onclick="moveUp(this)" title="Move up">
                                <i class="bi bi-chevron-up"></i>
                            </button>
                            <button type="button" onclick="moveDown(this)" title="Move down">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="stop-title" contenteditable="true">{{ title }}</div>
                    
                    <div class="stop-description" contenteditable="true">
                        {% for line in lines[1:] if line.strip() and 'Cost:' not in line and 'Duration:' not in line %}
                            {{ line.strip() }}<br>
                        {% endfor %}
                    </div>
                    
                    <div class="stop-meta">
                        {% for line in lines if 'Cost:' in line or 'Duration:' in line %}
                            {% if 'Cost:' in line %}
                                <div class="meta-item">
                                    <i class="bi bi-cash"></i>
                                    <span>{{ line.strip() }}</span>
                                </div>
                            {% endif %}
                            {% if 'Duration:' in line %}
                                <div class="meta-item">
                                    <i class="bi bi-hourglass-split"></i>
                                    <span>{{ line.strip() }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}

        <!-- Action Section -->
        <div class="form-section mt-4">
            <h4 class="mb-3"><i class="bi bi-floppy me-2"></i>Save Your Itinerary</h4>
            <form action="{{ url_for('main.save') }}" method="post" onsubmit="return prepareSave()">
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label for="title" class="form-label">Itinerary Title</label>
                        <input 
                            type="text" 
                            id="title"
                            name="title" 
                            class="form-control" 
                            placeholder="e.g., Tokyo Food Adventure, Paris Romantic Weekend"
                            required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-save me-2"></i> Save Itinerary
                        </button>
                    </div>
                </div>
                <input type="hidden" name="prompt" value="{{ prompt }}">
                <input type="hidden" name="itinerary" id="save_input">
            </form>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise me-2"></i> Create New Itinerary
                </a>
            </div>
        </div>
    </div>
    {% endif %}

{% endblock %}