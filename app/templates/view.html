{% extends "base.html" %}
{% set active_page = "saved" %}

{% block content %}
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-start mb-4 flex-wrap gap-3">
        <div>
            <h1 class="display-6 fw-bold mb-2">
                <i class="bi bi-map-fill text-primary me-2"></i>
                {{ itinerary_data.title }}
            </h1>
            <p class="text-muted mb-0">
                <i class="bi bi-calendar3 me-1"></i>
                Created: {{ itinerary_data.created_at[:10] }}
                <span class="mx-2">|</span>
                <i class="bi bi-hash me-1"></i>
                ID: {{ itinerary_data.id }}
            </p>
        </div>
        <form action="{{ url_for('main.delete', itinerary_id=itinerary_data.id) }}" method="post">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash me-1"></i> Delete Trip
            </button>
        </form>
    </div>

    <!-- Original Prompt Card -->
    <div class="form-section mb-4">
        <h6 class="text-uppercase text-muted fw-bold small mb-2">
            <i class="bi bi-chat-left-quote me-1"></i> Original Request
        </h6>
        <p class="mb-0" style="font-style: italic; color: var(--secondary);">
            "{{ itinerary_data.prompt }}"
        </p>
    </div>

    <!-- Itinerary Stops -->
    <div id="activities-container" class="itinerary-container">
        {% set sections = itinerary_data.itinerary.split('STOP:') %}
        {% for item in sections if item.strip() %}
            {% if 'EXTRA TIPS' in item.upper() %}
                <!-- Extra Tips Section -->
                <div class="extra-tips">
                    <h4><i class="bi bi-lightbulb-fill me-2"></i>Travel Tips</h4>
                    <ul>
                        {% set tips = item.replace('EXTRA TIPS', '').replace('Extra Tips', '').strip().split('\n') %}
                        {% for tip in tips if tip.strip() %}
                            <li>{{ tip.strip() }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <!-- Regular Stop -->
                {% set lines = item.strip().split('\n') %}
                {% set first_line = lines[0] if lines else '' %}
                {% set time_and_title = first_line.split(' - ', 1) %}
                {% set time = time_and_title[0].strip() if time_and_title|length > 0 else '' %}
                {% set title = time_and_title[1].strip() if time_and_title|length > 1 else first_line %}
                
                <div class="itinerary-stop">
                    <div class="stop-header">
                        <div class="stop-time">
                            <i class="bi bi-clock-fill"></i>
                            <span>{{ time }}</span>
                        </div>
                        <div class="stop-controls">
                            <button type="button" onclick="moveUp(this)" title="Move up">
                                <i class="bi bi-chevron-up"></i>
                            </button>
                            <button type="button" onclick="moveDown(this)" title="Move down">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="stop-title" contenteditable="true">{{ title }}</div>
                    
                    <div class="stop-description" contenteditable="true">
                        {% for line in lines[1:] if line.strip() and 'Cost:' not in line and 'Duration:' not in line %}
                            {{ line.strip() }}<br>
                        {% endfor %}
                    </div>
                    
                    <div class="stop-meta">
                        {% for line in lines if 'Cost:' in line or 'Duration:' in line %}
                            {% if 'Cost:' in line %}
                                <div class="meta-item">
                                    <i class="bi bi-cash"></i>
                                    <span>{{ line.strip() }}</span>
                                </div>
                            {% endif %}
                            {% if 'Duration:' in line %}
                                <div class="meta-item">
                                    <i class="bi bi-hourglass-split"></i>
                                    <span>{{ line.strip() }}</span>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- Action Section -->
    <div class="form-section mt-4">
        <h5 class="fw-bold mb-3">
            <i class="bi bi-pencil-square me-2"></i>Modify & Update
        </h5>
        
        <form action="{{ url_for('main.save') }}" method="post" onsubmit="return prepareSave()">
            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-8">
                    <label for="title" class="form-label">Save as New Version</label>
                    <input 
                        type="text" 
                        id="title"
                        name="title" 
                        class="form-control" 
                        value="{{ itinerary_data.title }} (Edited)" 
                        required>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-save me-2"></i>Save as New
                    </button>
                </div>
            </div>
            <input type="hidden" name="prompt" value="{{ itinerary_data.prompt }}">
            <input type="hidden" name="itinerary" id="save_input">
        </form>
        
        <div class="d-flex justify-content-between flex-wrap gap-2 mt-3">
            <a href="{{ url_for('main.saved') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to All Saved
            </a>
            <form action="{{ url_for('main.regenerate', itinerary_id=itinerary_data.id) }}" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise me-1"></i> Regenerate Fresh Version
                </button>
            </form>
        </div>
    </div>

{% endblock %}